---
title: "R Notebook"
output: html_notebook
---



---
title: "R Notebook"
output: html_notebook
---



# Setup

```{r}
library(ape)
library(tidyr)
library(MASS)
library(MuMIn)
library(ggplot2)
library(reshape2)
library(grid)
library(gridExtra)
library(ggfortify)
library(ggtree)
library(tibble)
library(vegan)
library(dplyr)

setwd("~/GitHub/432_Group5/Project")

# Load data
ltrsHB <- read.csv("./Data/HargreavesEcolLett data ltrsHB.csv")
ltrsNK <- read.csv("./Data/HargreavesEcolLett data ltrsNK.csv")

```


# Lifetime Reproductive Success Similiarity Analysis

Description of the variables:
\n
**year** = year plants were active
**transect** = elevational transect (where NK = Nakiska and HB = Hailstone Butte)
**site** = site seeds were transplanted into. L = low elevation, M = mid-elevation (range centre),
H = high-elevation (~100 m below range edge), E or HE = high-elevation range edge, A = above
range (HB), A1 = 1st site above the range at NK, A2 = second site above the range at NK
**treat** = treatment in warming experiment. TR = normal transplant (control), OTC = Open topped
warming chambers (warmed), dormant = plants found > 1 year after seeds planted
**Source** = source population: low-elevation from that transet (L), mid-elevation from that transect
(M), high-elevation (within 100 masl of absolute high-elevation range edge) from that transect
(H), edge (absolute high-elevation range edge E), high-elevation (2000 m) populations on
neighbouring Moose Mountain (MT) and Fortress Mountain (F), and seeds produced by plants
transplanted above the range the previous year (A)
**plant** = plantID within each 5x5 subplot (row.column from 1.1 = topleft plant to 5.5 = bottom right
plant)
**tbo** = top bitten off by mammal. 0 = no, plant intact, 1 = top bitten off
the primary stem, 2 = top bitten off some secondary stalks but primary stem intact
**Ln.tot** = total leaf nodes (each leaf node produces 2 leaves), including primary, secondary and
tertiary stems
**Fr.tot** = total fruits from all stems
**aveseed1** = average number of seeds per fruit from primary stem fruits
**aveseed2** = average number of seeds per fruit from secondary stem fruits
**totgoodseed** = total viable seed produced by the plant 
**totbadseed** = total non-viable seed produced by the plant


### Tidy Data

```{r}

# Select variables
ltrsHB_clean <- ltrsHB %>% select(year:treat, Source:totbadseed)
ltrsNK_clean <- ltrsNK %>% select(year:treat, Source:tbo, Ln.tot:totbadseed)

# Merge datasets
ltrsdat <- rbind(ltrsHB_clean, ltrsNK_clean)

# Remove data not from High, Medium, or Low elevation 
elevation <- c("H", "M", "L")
ltrsdat <- ltrsdat %>% 
  filter(Source %in% elevation)# %>% 
  #mutate(site = recode(site, A1 = "A")) %>% # Merge site A1 and A2 data into A to simplify
  #mutate(site = recode(site, A2 = "A")) %>% 
  #mutate(site = recode(site, HE = "H")) # Merge site HE into H to simplify

# Examine variable classes
str(ltrsdat)

# Subset into High, Medium, and Low Source Elevation
ltrsHigh <- ltrsdat %>% 
    filter(Source == "H") %>% 
    group_by(transect, site, plant) %>%
    mutate(dupID = row_number()) %>%
    ungroup() %>% 
    mutate(plantID = paste(transect, site, plant, dupID), sep = "_") %>% 
    select(plantID, tbo:totbadseed)

ltrsMed <- ltrsdat %>% 
    filter(Source == "M") %>% 
    group_by(transect, site, plant) %>%
    mutate(dupID = row_number()) %>%
    ungroup() %>% 
    mutate(plantID = paste(transect, site, plant, dupID), sep = "_") %>% 
    select(plantID, tbo:totbadseed)

ltrsLow <- ltrsdat %>% 
    filter(Source == "L") %>% 
    group_by(transect, site, plant) %>%
    mutate(dupID = row_number()) %>%
    ungroup() %>% 
    mutate(plantID = paste(transect, site, plant, dupID), sep = "_") %>% 
    select(plantID, tbo:totbadseed)

# Replace column numbers with plantID
ltrsH_OTU <- data.frame(ltrsHigh[,-1], row.names = ltrsHigh$plantID)
ltrsM_OTU <- data.frame(ltrsMed[,-1], row.names = ltrsMed$plantID)
ltrsL_OTU <- data.frame(ltrsLow[,-1], row.names = ltrsLow$plantID)


```

### Examine Dissimilarities for High Elevation Sourced Plants

Create Distance Matrix
```{r}

# Create distance values
ltrsH_Dist <- dist(ltrsH_OTU, method = 'euclidean')

# Reshape as matrix
ltrsH_DM <- as.matrix(ltrsH_Dist)

# Reshape to be plotted
ltrsH_plotdat <- melt(ltrsH_DM)

# Distance matrix plot
HDM_Plot <- ggplot(ltrsH_plotdat, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile() +
  scale_fill_gradientn(colours = c("white", "blue", "green", "red")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank())

HDM_Plot

```

Visualise similarities with Neighbour-Joining tree
```{r}
# NJ method
ltrsH_tree <- nj(ltrsH_Dist)


# Group by Source
SourceListH <- gsub("\\w+\\s+(\\w+)\\s.*","\\1", ltrsH_tree$tip.label)
SourceGroupH <- split(ltrsH_tree$tip.label, SourceListH)
SourceTreeH <- groupOTU(ltrsH_tree, SourceGroupH)

# Create tree
ltrsHNJTree <- ggtree(SourceTreeH, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsHNJTree


```

Visualise dissimilarities with Bray-Curtis Dissimilarity
```{r}

# Create distance matrix and tree
ltrsH_bray <- vegdist(ltrsH_OTU, method = "bray", binary = F, na.rm = T)
ltrsHTree_bray <- nj(ltrsH_bray)

# Group by Source
SourceGroupHBray <- split(ltrsHTree_bray$tip.label, SourceListH)
SourceTreeHBray <- groupOTU(ltrsHTree_bray, SourceGroupHBray)

# Create tree
ltrsHBrayTree <- ggtree(SourceTreeHBray, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsHBrayTree

```


Set up NMDS
```{r}

# Check which columns have na values
colnames(ltrsH_OTU)[colSums(is.na(ltrsH_OTU)) > 0]

# Convert aveseed to binary
ltrsH_bin <- ltrsH_OTU %>% replace(is.na(.), 0)
ltrsH_bin$aveseed1 = ifelse(ltrsH_bin$aveseed1 > 1, 1, 0)
ltrsH_bin$aveseed2 = ifelse(ltrsH_bin$aveseed2 > 1, 1, 0)

# Convert dataframe to matrix
character_matrix_H <- as.matrix(ltrsH_bin) 

# Perform NMDS on community data
character_NMDS_H <-  metaMDS(character_matrix_H, k = 2, trymax = 500)


```


### Examine Dissimilarities for Medium Elevation Sourced Plants

Create Distance Matrix
```{r}

# Create distance values
ltrsM_Dist <- dist(ltrsM_OTU, method = 'euclidean')

# Reshape as matrix
ltrsM_DM <- as.matrix(ltrsM_Dist)

# Reshape to be plotted
ltrsM_plotdat <- melt(ltrsM_DM)

# Distance matrix plot
MDM_Plot <- ggplot(ltrsM_plotdat, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile() +
  scale_fill_gradientn(colours = c("white", "blue", "green", "red")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank())

MDM_Plot

```

Visualise similarities with Neighbour-Joining tree
```{r}
# NJ method
ltrsM_tree <- nj(ltrsM_Dist)


# Group by Source
SourceListM <- gsub("\\w+\\s+(\\w+)\\s.*","\\1", ltrsM_tree$tip.label)
SourceGroupM <- split(ltrsM_tree$tip.label, SourceListM)
SourceTreeM <- groupOTU(ltrsM_tree, SourceGroupM)

# Create tree
ltrsMNJTree <- ggtree(SourceTreeM, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsMNJTree


```

Visualise dissimilarities with Bray-Curtis Dissimilarity
```{r}

# Create distance matrix and tree
ltrsM_bray <- vegdist(ltrsM_OTU, method = "bray", binary = F, na.rm = T)
ltrsMTree_bray <- nj(ltrsM_bray)

# Group by Source
SourceGroupMBray <- split(ltrsMTree_bray$tip.label, SourceListM)
SourceTreeMBray <- groupOTU(ltrsMTree_bray, SourceGroupMBray)

# Create tree
ltrsMBrayTree <- ggtree(SourceTreeMBray, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsMBrayTree

```


Set up NMDS
```{r}

# Check which columns have na values
colnames(ltrsM_OTU)[colSums(is.na(ltrsM_OTU)) > 0]

# Convert aveseed to binary
ltrsM_bin <- ltrsH_OTU %>% replace(is.na(.), 0)
ltrsM_bin$aveseed1 = ifelse(ltrsM_bin$aveseed1 > 1, 1, 0)
ltrsM_bin$aveseed2 = ifelse(ltrsM_bin$aveseed2 > 1, 1, 0)

# Convert dataframe to matrix
character_matrix_M <- as.matrix(ltrsM_bin) 

# Perform NMDS on community data
character_NMDS_M <-  metaMDS(character_matrix_M, k = 2, trymax = 500)


```




### Examine Dissimilarities for Low Elevation Sourced Plants

Create Distance Matrix
```{r}

# Create distance values
ltrsL_Dist <- dist(ltrsL_OTU, method = 'euclidean')

# Reshape as matrix
ltrsL_DM <- as.matrix(ltrsL_Dist)

# Reshape to be plotted
ltrsL_plotdat <- melt(ltrsL_DM)

# Distance matrix plot
LDM_Plot <- ggplot(ltrsL_plotdat, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile() +
  scale_fill_gradientn(colours = c("white", "blue", "green", "red")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank())

LDM_Plot

```

Visualise similarities with Neighbour-Joining tree
```{r}
# NJ method
ltrsL_tree <- nj(ltrsL_Dist)


# Group by Source
SourceListL <- gsub("\\w+\\s+(\\w+)\\s.*","\\1", ltrsL_tree$tip.label)
SourceGroupL <- split(ltrsL_tree$tip.label, SourceListL)
SourceTreeL <- groupOTU(ltrsL_tree, SourceGroupL)

# Create tree
ltrsLNJTree <- ggtree(SourceTreeL, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsLNJTree


```

Visualise dissimilarities with Bray-Curtis Dissimilarity
```{r}

# Create distance matrix and tree
ltrsL_bray <- vegdist(ltrsL_OTU, method = "bray", binary = F, na.rm = T)
ltrsLTree_bray <- nj(ltrsL_bray)

# Group by Source
SourceGroupLBray <- split(ltrsLTree_bray$tip.label, SourceListL)
SourceTreeLBray <- groupOTU(ltrsLTree_bray, SourceGroupLBray)

# Create tree
ltrsLBrayTree <- ggtree(SourceTreeLBray, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsLBrayTree

```


Set up NMDS
```{r}

# Check which columns have na values
colnames(ltrsL_OTU)[colSums(is.na(ltrsL_OTU)) > 0]

# Convert aveseed to binary
ltrsL_bin <- ltrsH_OTU %>% replace(is.na(.), 0)
ltrsL_bin$aveseed1 = ifelse(ltrsL_bin$aveseed1 > 1, 1, 0)
ltrsL_bin$aveseed2 = ifelse(ltrsL_bin$aveseed2 > 1, 1, 0)

# Convert dataframe to matrix
character_matrix_L <- as.matrix(ltrsL_bin) 

# Perform NMDS on community data
character_NMDS_L <-  metaMDS(character_matrix_L, k = 2, trymax = 500)


```



Visualize NMDS
```{r}

# Create NMDS data
ltrs_NMDS <- data.frame(NMDS1 = character_NMDS$points[,1],
                 NMDS2 = character_NMDS$points[,2])

# Create Source List
ltrsSource <- tibble::rownames_to_column(ltrs_OTU_NA, "plantID")
SourceListShort <- gsub("\\w+\\s+(\\w).+","\\1", ltrsSource$plantID)


# Quick plot for Source
qplot(x = NMDS1, y = NMDS2, colour = SourceListShort, alpha = I(0.6), data = ltrs_NMDS) +
  theme_bw()


# Plot for Source
ordiplot(character_NMDS, type = "n")
ordihull(character_NMDS, groups = SourceListShort, draw = "polygon", alpha = 0.15, label = F)
orditorp(character_NMDS, display = "species", col = "darkgrey", air = 0.01)
orditorp(character_NMDS, display = "sites", air = 0.01, cex = 1.25)

```




































































