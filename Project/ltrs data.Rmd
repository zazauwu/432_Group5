---
title: "R Notebook"
output: html_notebook
---



# Setup

```{r}
library(ape)
library(tidyr)
library(MASS)
library(MuMIn)
library(ggplot2)
library(reshape2)
library(grid)
library(gridExtra)
library(ggfortify)
library(ggtree)
library(tibble)
library(vegan)
library(dplyr)

# Load data
ltrsHB <- read.csv("./HargreavesEcolLett data ltrsHB.csv")
ltrsNK <- read.csv("./HargreavesEcolLett data ltrsNK.csv")

```


# Lifetime Reproductive Success Similiarity Analysis

Description of the variables:
\n
**year** = year plants were active
**transect** = elevational transect (where NK = Nakiska and HB = Hailstone Butte)
**site** = site seeds were transplanted into. L = low elevation, M = mid-elevation (range centre),
H = high-elevation (~100 m below range edge), E or HE = high-elevation range edge, A = above
range (HB), A1 = 1st site above the range at NK, A2 = second site above the range at NK
**treat** = treatment in warming experiment. TR = normal transplant (control), OTC = Open topped
warming chambers (warmed), dormant = plants found > 1 year after seeds planted
**Source** = source population: low-elevation from that transet (L), mid-elevation from that transect
(M), high-elevation (within 100 masl of absolute high-elevation range edge) from that transect
(H), edge (absolute high-elevation range edge E), high-elevation (2000 m) populations on
neighbouring Moose Mountain (MT) and Fortress Mountain (F), and seeds produced by plants
transplanted above the range the previous year (A)
**plant** = plantID within each 5x5 subplot (row.column from 1.1 = topleft plant to 5.5 = bottom right
plant)
**tbo** = top bitten off by mammal. 0 = no, plant intact, 1 = top bitten off
the primary stem, 2 = top bitten off some secondary stalks but primary stem intact
**Ln.tot** = total leaf nodes (each leaf node produces 2 leaves), including primary, secondary and
tertiary stems
**Fr.tot** = total fruits from all stems
**aveseed1** = average number of seeds per fruit from primary stem fruits
**aveseed2** = average number of seeds per fruit from secondary stem fruits
**totgoodseed** = total viable seed produced by the plant 
**totbadseed** = total non-viable seed produced by the plant


### Tidy Data

```{r}

# Select variables
ltrsHB_clean <- ltrsHB %>% select(year:treat, Source:totbadseed)
ltrsNK_clean <- ltrsNK %>% select(year:treat, Source:tbo, Ln.tot:totbadseed)

# Merge datasets
ltrsdat <- rbind(ltrsHB_clean, ltrsNK_clean)

# Examine variable classes
str(ltrsdat)

```

### Create Distance Matrix 

```{r}

# Select plant ID and physical parameters to compare similarity and create unique plant ID
ltrs_OTU_ID <- ltrsdat %>% 
    group_by(transect, Source, plant) %>%
    mutate(dupID = row_number()) %>%
    ungroup() %>% 
    mutate(plantID = paste(transect, Source, plant, dupID), sep = "_") %>% 
    select(plantID, tbo:totbadseed)

# Replace column numbers with plant ID
ltrs_OTU <- data.frame(ltrs_OTU_ID[,-1], row.names = ltrs_OTU_ID$plantID)

# Build distance matrix
# Create distance values
ltrs_Dist <- dist(ltrs_OTU, method = 'euclidean')

# Reshape as matrix
ltrs_DM <- as.matrix(ltrs_Dist)

# Reshape to be plotted
ltrs_plotdat <- melt(ltrs_DM)

# Distance matrix plot
ltrsDistMatrix <- ggplot(ltrs_plotdat, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile() +
  scale_fill_gradientn(colours = c("white", "blue", "green", "red")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank())

ltrsDistMatrix

```

### Visualize similarities with Neighbour-joining tree

```{r}
# NJ method
ltrs_tree <- nj(ltrs_Dist)

# Group by Source
SourceList <- gsub("\\w+\\s+(\\w).+","\\1", ltrs_tree$tip.label)
SourceGroup <- split(ltrs_tree$tip.label, SourceList)
SourceTree <- groupOTU(ltrs_tree, SourceGroup)

# Create tree
ltrsNJTree <- ggtree(SourceTree, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsNJTree


```
### Visualise dissimilarities with Bray-Cirtis Dissimilarity
```{r}

# Create distance matrix and tree
ltrs_bray <- vegdist(ltrs_OTU, method = "bray", binary = F, na.rm = T)
ltrs_tree_bray <- nj(ltrs_bray)

# Group by Source
SourceGroupBray <- split(ltrs_tree_bray$tip.label, SourceList)
SourceTreeBray <- groupOTU(ltrs_tree_bray, SourceGroupBray)

# Create tree
ltrsBrayTree <- ggtree(SourceTreeBray, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsBrayTree

```

### Examine Data with Non-metric Multidimensional Scaling NA REMOVED

Set up NMDS
```{r}

# Remove NAs from dataset
ltrs_OTU_NA <- na.omit(ltrs_OTU)

# Convert dataframe to matrix
character_matrix <- as.matrix(ltrs_OTU_NA) 

# Perform NMDS on community data
character_NMDS <-  metaMDS(character_matrix, k = 2, trymax = 100)


```

Visualize NMDS
```{r}

# Create NMDS data
ltrs_NMDS <- data.frame(NMDS1 = character_NMDS$points[,1],
                 NMDS2 = character_NMDS$points[,2])

# Create Source List
ltrsSource <- tibble::rownames_to_column(ltrs_OTU_NA, "plantID")
SourceListShort <- gsub("\\w+\\s+(\\w).+","\\1", ltrsSource$plantID)


# Quick plot for Source
qplot(x = NMDS1, y = NMDS2, colour = SourceListShort, alpha = I(0.6), data = ltrs_NMDS) +
  theme_bw()


# Plot for Source
ordiplot(character_NMDS, type = "n")
ordihull(character_NMDS, groups = SourceListShort, draw = "polygon", alpha = 0.15, label = F)
orditorp(character_NMDS, display = "species", col = "darkgrey", air = 0.01)
orditorp(character_NMDS, display = "sites", air = 0.01, cex = 1.25)

```

### Examine Data with Non-metric Multidimensional Scaling BINARY ENCODE

Set up NMDS
```{r}

# Check which columns have na values
colnames(ltrs_OTU)[colSums(is.na(ltrs_OTU)) > 0]

# Convert aveseed to binary
ltrs_bin <- ltrs_OTU %>% replace(is.na(.), 0)
ltrs_bin$aveseed1 = ifelse(ltrs_bin$aveseed1 > 1, 1, 0)
ltrs_bin$aveseed2 = ifelse(ltrs_bin$aveseed2 > 1, 1, 0)

# Convert dataframe to matrix
character_matrix <- as.matrix(ltrs_bin) 

# Perform NMDS on community data
character_NMDS <-  metaMDS(character_matrix, k = 2, trymax = 500)


```











































