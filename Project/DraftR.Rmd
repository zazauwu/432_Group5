---
title: "Project"
author: "Group5"
date: '2022-03-22'
output: pdf_document
---

GitHub Link: <https://github.com/zazauwu/432_Group5>

# Load Package

```{r}
library(ape)
library(tidyr)
library(MASS)
library(MuMIn)
library(ggplot2)
library(reshape2)
library(grid)
library(gridExtra)
library(ggfortify)
library(dplyr)

```

# Import Data

```{r}
###NK & HB lifetime reproductive success data
ltrsHB <- read.csv("./Data/HargreavesEcolLett data ltrsHB.csv")
ltrsNK <- read.csv("./Data/HargreavesEcolLett data ltrsNK.csv")

###NK & HB phenology data
phenNK <- read.csv("./Data/HargreavesEcolLett data phenologyNK.csv")
phenHB <- read.csv("./Data/HargreavesEcolLett data phenologyHB.csv")

###Climate by site data
clim <- read.csv("./Data/HargreavesEcolLett data hobo&ibutton summary by site.csv")
```

# Climate Effect Analysis

## Data Check and Modification

```{r}
sapply(clim, class)
```

```{r}
#variable explanation:
##winter limited:
  #d.snowpack.10.11 = days with snowpack winter 2010-2011
  #wTmin.10.11 = minimum temperature winter (C) at plant height 2010-2011
  #Dec.FebTav.10.11 = mean temperature at plant height from Dec1st 2010 - Feb 28th 2011
##
  #d.grows.11 = # days in growing season 2011 (start / end of gorwing season determined by sustained snow or frost)
  #GDD.grows.11 = # growing degree days (Tbase=10C, Tmax capped at 30C) in growing season of 2011
  #GDD.yr.11 = # growing degree days in 2011 (ie not truncated to estimated growing season)
  #avmaxminTJuly.11 = mean July 2011 temperature (C) calculated from daily min and max T: 
      ##mean(July1stmin + July1stmax + July2ndmin + July2ndmax + ... July31stmi + July31stmax)
  #avTJuly.11 = mean July 2011 temperature (C) calculated from raw data (ie >2 measurements per day)

#hence, convert the above columns into numeric variables
cols.num <- c("d.snowpack.11.12", "wTmin.11.12", "Dec.FebTav.11.12", "d.grows.12", "GDD.grows.12", "GDD.yr.12", "avmaxminTJuly.12", "avTJuly.12", "GDD.grows.13", "GDD.yr.13", "avmaxminTJuly.13", "avTJuly.13", "d.snowpack.13.14", "wTmin.13.14", "Dec.FebTav.13.14")
clim[cols.num] <- sapply(clim[cols.num],as.numeric)
sapply(clim, class)
head(clim)
```

```{r}
#combine 'transect' and 'site' info as a unique ID for each row
clim$ID <- as.factor(paste(clim$transect, clim$site, sep='.'))
row.names(clim) <- clim$ID

#remove 'transect' and 'site'
drops <- c("transect","site")
clim <- clim[ , !(names(clim) %in% drops)]

#move 'ID' to the first column
clim <- clim %>%
  relocate(ID)

#use 'melt' to convert the 'clim' data.frame into long format in which 'ID' is identifier variable, while the other are considered as the measured variables.
clim.me <- melt(clim, id.vars = "ID", measure.vars = 2:28)
head(clim.me)
```

```{r}
#use regular expression 'grepl' and 'gsub' to add 'year' column and remove date label in the 'variable' column
clim.me$year <- ifelse(grepl('10.11', clim.me$variable), 
                    'winter 10-11',
                    ifelse(grepl('11.12', clim.me$variable), 
                           'winter 11-12',
                           ifelse(grepl('12.13', clim.me$variable), 
                                  'winter 12-13',
                                  ifelse(grepl('13.14', clim.me$variable), 
                                         'winter 13-14',
                                         ifelse(grepl('grows.11|July.11|yr.11', clim.me$variable), 
                                                'year 2011',
                                                ifelse(grepl('grows.12|July.12|yr.12', clim.me$variable), 
                                                       'year 2012',
                                                       ifelse(grepl('grows.13|July.13|yr.13', clim.me$variable), 
                                                              'year 2013',
                                                              NA)))))))

clim.me <- clim.me %>%
  mutate(variable = gsub(".(\\d).*", "\\2", variable))

head(clim.me)
```

```{r}
#use 'dcast' to cast the molten data.frame into a data frame
clim.ca <- dcast(clim.me, ID + year ~ variable)
clim.ca$year <- as.factor(clim.ca$year)
head(clim.ca)
```

```{r}
#select all rows that contains winter season info and columns related to winter
clim.win <- subset(clim.ca, subset = year %in% c("winter 10-11", "winter 11-12", "winter 12-13", "winter 13-14"),
                   select=c(ID, year, d.snowpack, Dec.FebTav, wTmin))
head(clim.win)
```

```{r}
#select all rows that contains season info except for winter and columns related
clim.not.win <- subset(clim.ca, subset = year %in% c("year 2011", "year 2012", "year 2013"),
                   select=-c(d.snowpack, Dec.FebTav, wTmin))
head(clim.not.win)
```

```{r}
climDist <- dist(clim.ca, method = 'euclidean')
climDistMat <- as.matrix(climDist)
# rearrange the data from an n×n matrix to a n2×3 matrix
climPDat <- melt(climDistMat)
climPDat
# plot the matrix
ggplot(data = climPDat, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colours = c("white","blue","green","red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

# Phenology Analysis

## Combine Datasets and Subset

```{r}

# Merging HB and NK phenology datasets

phenmerged <- rbind(phenNK, phenHB)

# Subset phendat to variable we want

phendat <- phenmerged %>% dplyr::select(peak = transect, year, source = Source, site, treatment = treat, 
                                        final_fate = final.fate, DEm_plotavg = DEm.estplotav)



```

## PCA

Take phenology data and look at low v mid v high (Q2 and Q3) Are low similar to each other, are mid similar, are high similar Origin vs transplant location Phenotypic plasticity

```{r}
# delete rows with NA value??
PhenoNA <- phenmerged %>%
    na.omit
```

```{r}
names(phenmerged)
```

```{r}
str(phenmerged)
```

```{r}
phenmerged$year <- as.factor(phenmerged$year)
row.names(phenmerged) <- phenmerged$X
```

Do plants transplanted from low-, mid-, and high- ranges vary in their ability to phenologically adapt to ranges outside their native range? (Fig. 2)

```{r}

```
