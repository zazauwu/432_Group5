---
title: "Project"
author: "Group5"
date: '2022-03-22'
output: pdf_document
---

GitHub Link: <https://github.com/zazauwu/432_Group5>

# Load Package

```{r}
library(ape)
library(tidyr)
library(MASS)
library(MuMIn)
library(ggplot2)
library(reshape2)
library(grid)
library(gridExtra)
library(ggfortify)
library(vegan)
library(ggtree)
library(dplyr)

```

# Import Data

```{r}
###NK & HB lifetime reproductive success data
ltrsHB <- read.csv("./Data/HargreavesEcolLett data ltrsHB.csv")
ltrsNK <- read.csv("./Data/HargreavesEcolLett data ltrsNK.csv")

###NK & HB phenology data
phenNK <- read.csv("./Data/HargreavesEcolLett data phenologyNK.csv")
phenHB <- read.csv("./Data/HargreavesEcolLett data phenologyHB.csv")

###Climate by site data
clim <- read.csv("./Data/HargreavesEcolLett data hobo&ibutton summary by site.csv")
```

# Climate Effect Analysis

## Data Check and Modification

```{r}
sapply(clim, class)
```

```{r}
#variable explanation:
##winter limited:
  #d.snowpack.10.11 = days with snowpack winter 2010-2011
  #wTmin.10.11 = minimum temperature winter (C) at plant height 2010-2011
  #Dec.FebTav.10.11 = mean temperature at plant height from Dec1st 2010 - Feb 28th 2011
##
  #d.grows.11 = # days in growing season 2011 (start / end of gorwing season determined by sustained snow or frost)
  #GDD.grows.11 = # growing degree days (Tbase=10C, Tmax capped at 30C) in growing season of 2011
  #GDD.yr.11 = # growing degree days in 2011 (ie not truncated to estimated growing season)
  #avmaxminTJuly.11 = mean July 2011 temperature (C) calculated from daily min and max T: 
      ##mean(July1stmin + July1stmax + July2ndmin + July2ndmax + ... July31stmi + July31stmax)
  #avTJuly.11 = mean July 2011 temperature (C) calculated from raw data (ie >2 measurements per day)

#hence, convert the above columns into numeric variables
cols.num <- c("d.snowpack.11.12", "wTmin.11.12", "Dec.FebTav.11.12", "d.grows.12", "GDD.grows.12", "GDD.yr.12", "avmaxminTJuly.12", "avTJuly.12", "GDD.grows.13", "GDD.yr.13", "avmaxminTJuly.13", "avTJuly.13", "d.snowpack.13.14", "wTmin.13.14", "Dec.FebTav.13.14")
clim[cols.num] <- sapply(clim[cols.num],as.numeric)
sapply(clim, class)
head(clim)
```

```{r}
#combine 'transect' and 'site' info as a unique ID for each row
clim$ID <- as.factor(paste(clim$transect, clim$site, sep='.'))
row.names(clim) <- clim$ID

#remove 'transect' and 'site'
drops <- c("transect","site")
clim <- clim[ , !(names(clim) %in% drops)]

#move 'ID' to the first column
clim <- clim %>%
  relocate(ID)

#use 'melt' to convert the 'clim' data.frame into long format in which 'ID' is identifier variable, while the other are considered as the measured variables.
clim.me <- melt(clim, id.vars = "ID", measure.vars = 2:28)
head(clim.me)
```

```{r}
#use regular expression 'grepl' and 'gsub' to add 'year' column and remove date label in the 'variable' column
clim.me$year <- ifelse(grepl('10.11', clim.me$variable), 
                    'winter 10-11',
                    ifelse(grepl('11.12', clim.me$variable), 
                           'winter 11-12',
                           ifelse(grepl('12.13', clim.me$variable), 
                                  'winter 12-13',
                                  ifelse(grepl('13.14', clim.me$variable), 
                                         'winter 13-14',
                                         ifelse(grepl('grows.11|July.11|yr.11', clim.me$variable), 
                                                'year 2011',
                                                ifelse(grepl('grows.12|July.12|yr.12', clim.me$variable), 
                                                       'year 2012',
                                                       ifelse(grepl('grows.13|July.13|yr.13', clim.me$variable), 
                                                              'year 2013',
                                                              NA)))))))

clim.me <- clim.me %>%
  mutate(variable = gsub(".(\\d).*", "\\2", variable))

head(clim.me)
```

```{r}
#use 'dcast' to cast the molten data.frame into a data frame
clim.ca <- dcast(clim.me, ID + year ~ variable)
clim.ca$year <- as.factor(clim.ca$year)
head(clim.ca)
```

```{r}
#select all rows that contains winter season info and columns related to winter
clim.win <- subset(clim.ca, subset = year %in% c("winter 10-11", "winter 11-12", "winter 12-13", "winter 13-14"),
                   select=c(ID, year, d.snowpack, Dec.FebTav, wTmin))
head(clim.win)
```

```{r}
ggplot(clim.win, aes(x = year, y = d.snowpack, color = ID)) +
  geom_point(size = 0.8, alpha = 0.8) +
  geom_line(aes(group = ID), color = "grey", size = 0.3, alpha = 0.5) +
  xlab("Winter 2010 - 2014") +
  ylab("Days with Snowpack") +
  theme_classic()
```
Figure 1. 

```{r}
#select all rows that contains season info except for winter and columns related
clim.not.win <- subset(clim.ca, subset = year %in% c("year 2011", "year 2012", "year 2013"),
                   select=-c(d.snowpack, Dec.FebTav, wTmin))
head(clim.not.win)
```
```{r}
ggplot(clim.not.win, aes(x = year, y = avmaxminTJuly, color = ID)) +
  geom_point(size = 0.8, alpha = 0.8) +
  geom_line(aes(group = ID), color = "grey", size = 0.3, alpha = 0.5) +
  xlab("Year 2011 - 2013") +
  ylab("Mean July temperature (ºC)") +
  theme_classic()
```

## Visualize Climate Similarity/Disimilarity

### In winter starting from 2010 to 2014

```{r}
clim.win$tr.si.yr <- paste(clim.win$ID, clim.win$year)
row.names(clim.win) <- clim.win$tr.si.yr
clim.win <- subset(clim.win, select = -c(ID, year) )
head(clim.win)
```

```{r}
climwDist <- dist(clim.win, method = 'euclidean')
climwDistMat <- as.matrix(climwDist)
# rearrange the data from an n×n matrix to a n2×3 matrix
climwPDat <- melt(climwDistMat)

# plot the matrix
ggplot(data = climwPDat, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colours = c("white","blue","green","red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```
### In other seasons except winter from 2011 to 2013

```{r}
clim.not.win$tr.si.yr <- paste(clim.not.win$ID, clim.not.win$year)
row.names(clim.not.win) <- clim.not.win$tr.si.yr
clim.not.win <- subset(clim.not.win, select = -c(ID, year) )
head(clim.not.win)
```

```{r}
climnwDist <- dist(clim.not.win, method = 'euclidean')
climnwDistMat <- as.matrix(climnwDist)
# rearrange the data from an n×n matrix to a n2×3 matrix
climnwPDat <- melt(climnwDistMat)

# plot the matrix
ggplot(data = climnwPDat, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradientn(colours = c("white","blue","green","red")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

# Phenology Analysis

## Combine Datasets and Subset

```{r}

# Merging HB and NK phenology datasets

phenmerged <- rbind(phenNK, phenHB)

# Subset phendat to variable we want

phendat <- phenmerged %>% dplyr::select(peak = transect, year, source = Source, site, treatment = treat, 
                                        final_fate = final.fate, DEm_plotavg = DEm.estplotav)

head(phendat)
```
# Lifetime Reproductive Success Similiarity Analysis

Description of the variables:
\n
**year** = year plants were active
**transect** = elevational transect (where NK = Nakiska and HB = Hailstone Butte)
**site** = site seeds were transplanted into. L = low elevation, M = mid-elevation (range centre),
H = high-elevation (~100 m below range edge), E or HE = high-elevation range edge, A = above
range (HB), A1 = 1st site above the range at NK, A2 = second site above the range at NK
**treat** = treatment in warming experiment. TR = normal transplant (control), OTC = Open topped
warming chambers (warmed), dormant = plants found > 1 year after seeds planted
**Source** = source population: low-elevation from that transet (L), mid-elevation from that transect
(M), high-elevation (within 100 masl of absolute high-elevation range edge) from that transect
(H), edge (absolute high-elevation range edge E), high-elevation (2000 m) populations on
neighbouring Moose Mountain (MT) and Fortress Mountain (F), and seeds produced by plants
transplanted above the range the previous year (A)
**plant** = plantID within each 5x5 subplot (row.column from 1.1 = topleft plant to 5.5 = bottom right
plant)
**tbo** = top bitten off by mammal. 0 = no, plant intact, 1 = top bitten off
the primary stem, 2 = top bitten off some secondary stalks but primary stem intact
**Ln.tot** = total leaf nodes (each leaf node produces 2 leaves), including primary, secondary and
tertiary stems
**Fr.tot** = total fruits from all stems
**aveseed1** = average number of seeds per fruit from primary stem fruits
**aveseed2** = average number of seeds per fruit from secondary stem fruits
**totgoodseed** = total viable seed produced by the plant 
**totbadseed** = total non-viable seed produced by the plant


## Tidy Data

```{r}
# Select variables
ltrsHB_clean <- ltrsHB %>% select(year:treat, Source:totbadseed)
ltrsNK_clean <- ltrsNK %>% select(year:treat, Source:tbo, Ln.tot:totbadseed)

# Merge datasets
ltrsdat <- rbind(ltrsHB_clean, ltrsNK_clean)

# Remove data not from High, Medium, or Low elevation 
elevation <- c("H", "M", "L")
ltrsdat <- ltrsdat %>% 
  filter(Source %in% elevation)# %>% 
  #mutate(site = recode(site, A1 = "A")) %>% # Merge site A1 and A2 data into A to simplify
  #mutate(site = recode(site, A2 = "A")) %>% 
  #mutate(site = recode(site, HE = "H")) # Merge site HE into H to simplify

# Examine variable classes
str(ltrsdat)
```

```{r}
#ltrsdat$year <- as.factor(ltrsdat$year)
#ltrsdat$transect <- as.factor(ltrsdat$transect)
#ltrsdat$site <- as.factor(ltrsdat$site)
#ltrsdat$treat <- as.factor(ltrsdat$treat)
#ltrsdat$Source <- as.factor(ltrsdat$Source)
#ltrsdat$tbo <- as.factor(ltrsdat$tbo)
```


```{r}
# Subset into High, Medium, and Low Source Elevation
ltrsHigh <- ltrsdat %>% 
    filter(Source == "H") %>% 
    group_by(transect, site, plant) %>%
    mutate(dupID = row_number()) %>%
    ungroup() %>% 
    mutate(plantID = paste(transect, site, plant, dupID), sep = "_") %>% 
    select(plantID, tbo:totbadseed)

ltrsMed <- ltrsdat %>% 
    filter(Source == "M") %>% 
    group_by(transect, site, plant) %>%
    mutate(dupID = row_number()) %>%
    ungroup() %>% 
    mutate(plantID = paste(transect, site, plant, dupID), sep = "_") %>% 
    select(plantID, tbo:totbadseed)

ltrsLow <- ltrsdat %>% 
    filter(Source == "L") %>% 
    group_by(transect, site, plant) %>%
    mutate(dupID = row_number()) %>%
    ungroup() %>% 
    mutate(plantID = paste(transect, site, plant, dupID), sep = "_") %>% 
    select(plantID, tbo:totbadseed)

# Replace column numbers with plantID
ltrsH_OTU <- data.frame(ltrsHigh[,-1], row.names = ltrsHigh$plantID)
ltrsM_OTU <- data.frame(ltrsMed[,-1], row.names = ltrsMed$plantID)
ltrsL_OTU <- data.frame(ltrsLow[,-1], row.names = ltrsLow$plantID)


```

## Examine Dissimilarities for High Elevation Sourced Plants

### Create Distance Matrix

```{r}

# Create distance values
ltrsH_Dist <- dist(ltrsH_OTU, method = 'euclidean')

# Reshape as matrix
ltrsH_DM <- as.matrix(ltrsH_Dist)

# Reshape to be plotted
ltrsH_plotdat <- melt(ltrsH_DM)

# Distance matrix plot
HDM_Plot <- ggplot(ltrsH_plotdat, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile() +
  scale_fill_gradientn(colours = c("white", "blue", "green", "red")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank())

HDM_Plot

```

## Visualise similarities with Neighbour-Joining tree

```{r}
# NJ method
ltrsH_tree <- nj(ltrsH_Dist)


# Group by Source
SiteListH <- gsub("\\w+\\s+(\\w+)\\s.*","\\1", ltrsH_tree$tip.label)
SiteGroupH <- split(ltrsH_tree$tip.label, SiteListH)
SiteTreeH <- groupOTU(ltrsH_tree, SiteGroupH)

# Create tree
ltrsHNJTree <- ggtree(SiteTreeH, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsHNJTree

```

## Visualise dissimilarities with Bray-Curtis Dissimilarity

```{r}

# Create distance matrix and tree
ltrsH_bray <- vegdist(ltrsH_OTU, method = "bray", binary = F, na.rm = T)
ltrsHTree_bray <- nj(ltrsH_bray)

# Group by Source
SiteGroupHBray <- split(ltrsHTree_bray$tip.label, SiteListH)
SiteTreeHBray <- groupOTU(ltrsHTree_bray, SiteGroupHBray)

# Create tree
ltrsHBrayTree <- ggtree(SiteTreeHBray, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsHBrayTree

```
## Examine Dissimilarities for Medium Elevation Sourced Plants

### Create Distance Matrix

```{r}

# Create distance values
ltrsM_Dist <- dist(ltrsM_OTU, method = 'euclidean')

# Reshape as matrix
ltrsM_DM <- as.matrix(ltrsM_Dist)

# Reshape to be plotted
ltrsM_plotdat <- melt(ltrsM_DM)

# Distance matrix plot
MDM_Plot <- ggplot(ltrsM_plotdat, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile() +
  scale_fill_gradientn(colours = c("white", "blue", "green", "red")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank())

MDM_Plot

```

## Visualise similarities with Neighbour-Joining tree

```{r}
# NJ method
ltrsM_tree <- nj(ltrsM_Dist)


# Group by Source
SiteListM <- gsub("\\w+\\s+(\\w+)\\s.*","\\1", ltrsM_tree$tip.label)
SiteGroupM <- split(ltrsM_tree$tip.label, SiteListM)
SiteTreeM <- groupOTU(ltrsM_tree, SiteGroupM)

# Create tree
ltrsMNJTree <- ggtree(SiteTreeM, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsMNJTree


```
## Visualise dissimilarities with Bray-Curtis Dissimilarity

```{r}

# Create distance matrix and tree
ltrsM_bray <- vegdist(ltrsM_OTU, method = "bray", binary = F, na.rm = T)
ltrsMTree_bray <- nj(ltrsM_bray)

# Group by Source
SiteGroupMBray <- split(ltrsMTree_bray$tip.label, SiteListM)
SiteTreeMBray <- groupOTU(ltrsMTree_bray, SiteGroupMBray)

# Create tree
ltrsMBrayTree <- ggtree(SiteTreeMBray, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsMBrayTree

```
## Examine Dissimilarities for Low Elevation Sourced Plants

### Create Distance Matrix

```{r}

# Create distance values
ltrsL_Dist <- dist(ltrsL_OTU, method = 'euclidean')

# Reshape as matrix
ltrsL_DM <- as.matrix(ltrsL_Dist)

# Reshape to be plotted
ltrsL_plotdat <- melt(ltrsL_DM)

# Distance matrix plot
LDM_Plot <- ggplot(ltrsL_plotdat, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile() +
  scale_fill_gradientn(colours = c("white", "blue", "green", "red")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank())

LDM_Plot

```

## Visualise similarities with Neighbour-Joining tree

```{r}
# NJ method
ltrsL_tree <- nj(ltrsL_Dist)


# Group by Source
SiteListL <- gsub("\\w+\\s+(\\w+)\\s.*","\\1", ltrsL_tree$tip.label)
SiteGroupL <- split(ltrsL_tree$tip.label, SiteListL)
SiteTreeL <- groupOTU(ltrsL_tree, SiteGroupL)

# Create tree
ltrsLNJTree <- ggtree(SiteTreeL, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsLNJTree


```

## Visualise dissimilarities with Bray-Curtis Dissimilarity

```{r}

# Create distance matrix and tree
ltrsL_bray <- vegdist(ltrsL_OTU, method = "bray", binary = F, na.rm = T)
ltrsLTree_bray <- nj(ltrsL_bray)

# Group by Source
SiteGroupLBray <- split(ltrsLTree_bray$tip.label, SiteListL)
SiteTreeLBray <- groupOTU(ltrsLTree_bray, SiteGroupLBray)

# Create tree
ltrsLBrayTree <- ggtree(SiteTreeLBray, layout = "circular", aes(colour = group)) +
  geom_tiplab(size = 2, aes(angle = 0)) +
  theme(legend.position = "right")

ltrsLBrayTree

```

## PCA

Using 'totgoodseed' to measure the indirect fitness of the sampling plant communities.

```{r}
head(ltrsdat)
```
```{r}
ltrs_pc <- subset(ltrsdat, subset = site %in% c("L", "M", "H"),
                   select=-c(aveseed2, totbadseed))
head(ltrs_pc)
```
### performs a principal components analysis on the numeric data matrix
```{r}
# delet NA values
ltrs_pc <- ltrs_pc %>%
  na.omit()

ltrsfull <- princomp(ltrs_pc[,8:10], cor = T)
summary(ltrsfull)
```

```{r}
loadings(ltrsfull)
```

```{r}
head(ltrsfull$scores)
```

```{r}
 round(cor(ltrsfull$scores),3)
```

```{r}
library(factoextra)

eig.val1 <- get_eigenvalue(ltrsfull)
eig.val1
```
PC axes are uncorrelated with each other: that the diagonal is 1 represents the correlation of each PC axis with itself, while the off-diagonals are zero, meaning that the correlation coefficient is <0.001.
Besides, for the dimensions, an eigenvalue > 1 indicates that the principal component (PCs) accounts for more variance than accounted by one of the original variables in standardized data.

```{r}
PCltrsMod1 <- lm(PC1 ~ site*treat, data = ltrs_pc)
summary(PCltrsMod1)
anova(PCltrsMod1)
```

```{r}
PCltrsMod2 <- lm(PC2 ~ site*treat, data = ltrs_pc)
summary(PCltrsMod2)
anova(PCltrsMod2)
```

```{r}
PCltrsMod3 <- lm(PC3 ~ site*treat, data = ltrs_pc)
summary(PCltrsMod3)
anova(PCltrsMod3)
```

## Ploting PCA

```{r}
ltrs_pc$PC1 <- ltrsfull$scores[,1]
ltrs_pc$PC2 <- ltrsfull$scores[,2]
ltrs_pc$PC3 <- ltrsfull$scores[,3]
qplot(x = PC1, y = PC2, color = site, facets = "Source", data = ltrs_pc) +
theme_classic()
```

```{r}
fviz_pca_ind(ltrsfull,
             col.ind = ltrs_pc$Source, # color by groups
             palette = c("#00AFBB",  "#FC4E07", "#9FA0C5"),
             addEllipses = TRUE, # Concentration ellipses
             ellipse.type = "confidence",
             legend.title = "Sources",
             repel = TRUE
             )
```
```{r}
autoplot(ltrsfull, data = ltrs_pc, size = 0.6, loadings = T, loadings.label = T) + theme_classic()
```

## Plotting Factor Analysis

### Calculate principal components

```{r}
library(FactoMineR)

## FAMD
ltrs_fa <- subset(ltrs_pc, 
                   select=-c(PC1, PC2, PC3))

ltrs.famd <- FAMD(ltrs_fa, 
                 sup.var = 11,  ## Set the target variable "totgoodseed" as a supplementary variable
                 graph = FALSE, 
                 ncp=25)

## Inspect principal components
get_eigenvalue(ltrs.famd)
```

```{r}
#to do factor analysis, we change 'totgoodseed' from numeric variable into catergorical as 'low', 'med', 'high'
ltrs_fa
```

```{r}
## Plot individual observations
fviz_famd_ind(ltrs.famd, label = "none", 
              habillage = "totgoodseed", palette = c("#00AFBB", "#FC4E07"), # color by groups 
              repel = TRUE, alpha.ind = 0.5) + 
  xlim(-5, 6) + ylim (-4.5, 4.5) +
  theme(text = element_text(size=20), axis.text.x = element_text(size=20), axis.text.y = element_text(size=20))
```












